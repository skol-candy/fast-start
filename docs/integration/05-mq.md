---
Title: Messaging (MQ)
hide:
    - toc
---


# Deploy Enterprise Messaging - MQ 

Helpful Links:

- [MQ Sales Kit](https://ibm.seismic.com/Link/Content/DC37QVDTC9Rd6Gh2D2Q4BBpDP7TG){target="_blank"}

## Catalog Source & Deploy the Operator

1. Install MQ Catalog Source:
   ```bash
   oc apply -f catalog-sources/${CP4I_VER}/09-mq-catalog-source.yaml 
   ```
   Confirm the catalog source has been deployed successfully before moving to the next step running the following command: 
   ```bash
   oc get catalogsources ibmmq-operator-catalogsource -n openshift-marketplace -o jsonpath='{.status.connectionState.lastObservedState}';echo
   ```
   You should get a response like this:
   ```
   READY
   ```
2. Install MQ Operator:
   ```bash
   oc apply -f subscriptions/${CP4I_VER}/06-mq-subscription.yaml
   ```
   Confirm the operator has been deployed successfully before moving to the next step running the following command:
   ```bash
   SUB_NAME=$(oc get deployment ibm-mq-operator -n openshift-operators --ignore-not-found -o jsonpath='{.metadata.labels.olm\.owner}');if [ ! -z "$SUB_NAME" ]; then oc get csv/$SUB_NAME --ignore-not-found -o jsonpath='{.status.phase}';fi;echo
   ```
   You should get a response like this:
   ```
   Succeeded
   ```
## Deploy the MQ Instance (Native HA)

!!! Info "What is MQ Native HA?"
      Native HA is a high availability solution aimed at container deployments of IBM MQ. Native HA uses log replication to keep three instances of a queue manager running on different nodes up to date. One instance is active at any one time and processes messages.  This is a very common containerized MQ configuration.

1. Set MQ namespace environment variable:
   ```bash
   export MQ_NAMESPACE=cp4i-mq
   ```
2. Create certificates and extra route:
   ```bash
   scripts/10a-qmgr-pre-config.sh
   ```
3. Create configmaps with MQ configuration:
   ```bash
   oc apply -f resources/03c-qmgr-mqsc-config.yaml -n tools
   oc apply -f resources/03e-qmgr-mqsc-config-ea.yaml -n tools
   oc apply -f resources/03g-qmgr-ini-config.yaml -n tools
   ```
4. Deploy MQ Queue Manager instance:
   ```bash
   scripts/10b-qmgr-inst-deploy.sh
   ```
   Confirm the instance has been deployed successfully before moving to the next step running the following command:
   ```bash
   oc get queuemanager qmgr-demo -n tools -o jsonpath='{.status.phase}';echo
   ```
   You are looking for the following:

   ```
   Running
   ```
!!! Info "While you are waiting ..."
      Take a look at the `yaml` used to deploy the MQ instance.

      ```{ .yaml linenums="1" hl_lines="10 14-22 25" .no-copy title="12-qmgr-native-ha-instance.yaml" }
      apiVersion: mq.ibm.com/v1beta1
      kind: QueueManager
      metadata:
      annotations:
         com.ibm.mq/write-defaults-spec: 'false'
      name: qmgr-native-ha
      spec:
      license:
         accept: true
         license: L-QYVA-B365MB
         use: NonProduction
      queueManager:
         name: QMGRNATIVEHA
         resources:
            limits:
            cpu: 500m
            requests:
            cpu: 500m
         storage:
            queueManager:
            type: persistent-claim
            defaultClass: ${OCP_BLOCK_STORAGE}
            defaultDeleteClaim: true
         availability:
            type: NativeHA
      template:
         pod:
            containers:
            - env:
                  - name: MQSNOAUT
                  value: 'yes'
               name: qmgr
      version: ${MQ_VERSION}
      web:
         console:
            authentication:
            provider: integration-keycloak
            authorization:
            provider: integration-keycloak
         enabled: true
      ```
### Create CCDT (optional):

!!! Warning "Optional Steps to Follow"
      The rest of the steps below are not required for the bootcamp but help to configure additional features within the demo environment.  

Client Channel Definition Table (CCDT) allows you to connect an IBMÂ® MQ client application to any level of queue manager.

   ```bash
   scripts/10c-qmgr-post-config.sh
   ```

### Deploy Kafka Connect MQ Connectors (Optional)

1. MQ Source Connector:
   ```bash
   oc apply -f resources/02b-es-mq-source.yaml
   ```
2. MQ Sink Connector:
   ```bash
   oc apply -f resources/02c-es-mq-sink.yaml
   ```
3. MQ Source Connector for Event Automation:
   ```bash
   oc apply -f resources/02e-es-mq-source-ea.yaml
   ```

### Deploy other Queue Managers (Optional)

   ```bash
   oc apply -f instances/${CP4I_VER}/common/09-qmgr-ephemeral-single-instance.yaml -n ${MQ_NAMESPACE}
   oc apply -f instances/${CP4I_VER}/${OCP_TYPE}/10-qmgr-base-log-single-instance.yaml -n ${MQ_NAMESPACE}
   oc apply -f instances/${CP4I_VER}/${OCP_TYPE}/11a-qmgr-base-storage-multi-instance.yaml -n ${MQ_NAMESPACE}
   oc apply -f instances/${CP4I_VER}/${OCP_TYPE}/11b-qmgr-advanced-storage-multi-instance.yaml -n ${MQ_NAMESPACE}
   scripts/10e-qmgr-native-ha-inst-deploy.sh
   scripts/10f-qmgr-ext-np-inst-deploy.sh
   ```
   You can check the status using the following command:
   ```bash
   oc get queuemanager --all-namespaces
   ```
   Output will vary depending on which instances you decide to deploy.

## Optional Cluster Configurations

### Deploy Uniform Cluster configuration with Native HA using manual approach (optional):

!!! Info "What is a Uniform Cluster?"
      An IBM MQ uniform cluster is a group of queue managers that are configured similarly and work together to balance workloads and distribute messages. Uniform clusters are designed to be scalable and available, and they can be used to connect applications to a single group of queue managers.

1. Create configurations:
   ```
   oc apply -f resources/03d-qmgr-uniform-cluster-config.yaml
   ```
2. Prepare certificates for Queue Managers:
   ```
   scripts/10d-qmgr-uc-pre-config.sh
   ```
3. Deploy Queue Manager 1:
   ```
   oc apply -f instances/${CP4I_VER}/${OCP_TYPE}/13a-qmgr-uniform-cluster-qm1.yaml -n cp4i
   ```
4. Deploy Queue Manager 2:
   ```
   oc apply -f instances/${CP4I_VER}/${OCP_TYPE}/13b-qmgr-uniform-cluster-qm2.yaml -n cp4i
   ```
   Confirm the instances have been deployed successfully running the following command:
   ```
   oc get queuemanager -n cp4i
   ```
   Note this will take few minutes, but at the end you should get a response like this:
   ```
   NAME                  PHASE
   uniform-cluster-qm1   Running
   uniform-cluster-qm2   Running
   ```
### Deploy Uniform Cluster configuration with Native HA using ArgoCD (Optional):

1. Install dependency:
   ```
   oc apply -f resources/00-gitops-clusterissuer.yaml
   ``` 
2. Add RoleBinding to allow ArgoCD to use the namespace:
   ```bash
   oc apply -f resources/00-gitops-rolebinding.yaml
   ```
3. Deploy ArgoCD application:
   ```bash
   oc apply -f resources/00-gitops-app.yaml
   ```
   You can review the app and explore the repo that has the definitions.
4. Confirm the instances have been deployed successfully running the following command:
   ```bash
   oc get queuemanager -n mq-argocd
   ```
   Note this will take few minutes, but at the end you should get a response like this:
   ```
   NAME      PHASE
   qm01-qm   Running
   qm02-qm   Running
   ```
### Create extra resources to demo MQ Uniform Cluster (optional):
1. Create CCDT to be used by App:
   ```bash
   oc apply -f resources/04a-nginx-ccdt-configmap.yaml
   ``` 
2. Deploy NGINX instance to serve CCDT:
   ```bash
   oc apply -f resources/04b-nginx-deployment.yaml
   ```
   Confirm the instances has been deployed successfully before moving to the next step running the following command:
   ```
   oc get pods -n cp4i | grep nginx
   ```
   You should get a response like this:
   ```bash
   nginx-deployment-575c9b7b64-c457v   1/1     Running   0               5h11m
   ```
3. Create service for NGINX to be used by App:
   ```bash
   oc apply -f resources/04c-nginx-service.yaml
   ```


